hpc.wltrc = zeros(hpc.Nc, hpc.ipl, length(hpc.wltrc));
hpc.wltrc(:,wlpl,:) = 1;


core_id1 = [1:5:hpc.Nc];
core_id2 = [2:3:hpc.Nc];


for i=1:hpc.Nc
    if ismember(i, core_id1)
        hpc.wltrc(i,:,:) = ones(hpc.ipl, length(hpc.wltrc)).*[0 0 0.1 0.4 0.5]';
    elseif ismember(i, core_id2)
        hpc.wltrc(i,:,:) = ones(hpc.ipl, length(hpc.wltrc)).*[0 0.6 0.4 0 0]';
    end
end


%%

hierarchical_lut_reduction(lut, 1)

%%

lut = [ 1 1 1 2 2
        2 3 3 2 1
        4 5 4 1 2
        5 5 6 7 8];

%{

lut = [

    0.2414    0.1568    0.0636   -0.0474   -0.1772   -0.3265   -0.4959   -0.6622   -0.8423   -1.0348   -1.2370   -1.4454   -1.6164   -1.7748   -1.9206
    0.2260    0.1416    0.0488   -0.0619   -0.1912   -0.3401   -0.5087   -0.6740   -0.8530   -1.0439   -1.2441   -1.4501   -1.6179   -1.7723   -1.9130
    0.2106    0.1265    0.0339   -0.0764   -0.2053   -0.3535   -0.5214   -0.6858   -0.8635   -1.0528   -1.2511   -1.4545   -1.6191   -1.7694   -1.9049
    0.1953    0.1114    0.0191   -0.0908   -0.2193   -0.3669   -0.5340   -0.6974   -0.8739   -1.0616   -1.2579   -1.4587   -1.6200   -1.7661   -1.8962
    0.1800    0.0963    0.0043   -0.1053   -0.2332   -0.3802   -0.5466   -0.7089   -0.8842   -1.0703   -1.2644   -1.4626   -1.6205   -1.7623   -1.8869
    0.1647    0.0812   -0.0105   -0.1196   -0.2471   -0.3935   -0.5590   -0.7204   -0.8943   -1.0787   -1.2708   -1.4662   -1.6207   -1.7581   -1.8771
    0.1494    0.0662   -0.0252   -0.1340   -0.2609   -0.4067   -0.5714   -0.7317   -0.9043   -1.0870   -1.2769   -1.4696   -1.6205   -1.7534   -1.8666
    0.1341    0.0512   -0.0399   -0.1483   -0.2747   -0.4198   -0.5837   -0.7429   -0.9141   -1.0951   -1.2828   -1.4726   -1.6199   -1.7482   -1.8556
    0.1189    0.0362   -0.0546   -0.1625   -0.2885   -0.4329   -0.5959   -0.7540   -0.9238   -1.1030   -1.2884   -1.4754   -1.6190   -1.7425   -1.8439
    0.1037    0.0212   -0.0692   -0.1768   -0.3021   -0.4459   -0.6080   -0.7650   -0.9334   -1.1108   -1.2938   -1.4778   -1.6176   -1.7363   -1.8316
    0.0885    0.0063   -0.0838   -0.1909   -0.3158   -0.4588   -0.6200   -0.7759   -0.9428   -1.1183   -1.2990   -1.4799   -1.6158   -1.7296   -1.8186
    0.0733   -0.0086   -0.0984   -0.2050   -0.3293   -0.4716   -0.6319   -0.7866   -0.9520   -1.1257   -1.3039   -1.4817   -1.6137   -1.7224   -1.8050
    0.0581   -0.0235   -0.1129   -0.2191   -0.3428   -0.4844   -0.6438   -0.7973   -0.9611   -1.1328   -1.3085   -1.4832   -1.6111   -1.7147   -1.7906
    0.0430   -0.0384   -0.1274   -0.2332   -0.3563   -0.4971   -0.6555   -0.8078   -0.9701   -1.1397   -1.3129   -1.4843   -1.6081   -1.7064   -1.7756
    0.0279   -0.0532   -0.1419   -0.2471   -0.3696   -0.5097   -0.6671   -0.8181   -0.9788   -1.1464   -1.3170   -1.4851   -1.6046   -1.6975   -1.7599
    0.0128   -0.0680   -0.1563   -0.2611   -0.3830   -0.5222   -0.6786   -0.8284   -0.9874   -1.1530   -1.3208   -1.4855   -1.6007   -1.6881   -1.7434
   -0.0023   -0.0827   -0.1707   -0.2750   -0.3962   -0.5347   -0.6901   -0.8385   -0.9959   -1.1592   -1.3244   -1.4856   -1.5964   -1.6781   -1.7262
   -0.0173   -0.0975   -0.1850   -0.2888   -0.4094   -0.5470   -0.7014   -0.8484   -1.0041   -1.1653   -1.3277   -1.4853   -1.5915   -1.6675   -1.7082
   -0.0323   -0.1122   -0.1993   -0.3026   -0.4225   -0.5593   -0.7126   -0.8583   -1.0122   -1.1711   -1.3306   -1.4846   -1.5862   -1.6563   -1.6895
   -0.0473   -0.1268   -0.2136   -0.3163   -0.4356   -0.5715   -0.7237   -0.8679   -1.0201   -1.1767   -1.3333   -1.4836   -1.5804   -1.6444   -1.6699
   -0.0623   -0.1415   -0.2278   -0.3300   -0.4485   -0.5836   -0.7346   -0.8775   -1.0277   -1.1821   -1.3357   -1.4821   -1.5741   -1.6319   -1.6495
   -0.0772   -0.1561   -0.2419   -0.3436   -0.4614   -0.5956   -0.7455   -0.8868   -1.0352   -1.1872   -1.3377   -1.4803   -1.5673   -1.6187   -1.6283
   -0.0921   -0.1706   -0.2561   -0.3571   -0.4743   -0.6075   -0.7562   -0.8961   -1.0425   -1.1920   -1.3394   -1.4780   -1.5599   -1.6049   -1.6062
   -0.1070   -0.1852   -0.2701   -0.3706   -0.4870   -0.6193   -0.7668   -0.9051   -1.0496   -1.1966   -1.3408   -1.4753   -1.5520   -1.5904   -1.5832
   -0.1219   -0.1997   -0.2842   -0.3841   -0.4997   -0.6310   -0.7773   -0.9140   -1.0565   -1.2009   -1.3419   -1.4722   -1.5436   -1.5752   -1.5594
   -0.1367   -0.2141   -0.2981   -0.3974   -0.5123   -0.6426   -0.7876   -0.9228   -1.0632   -1.2050   -1.3426   -1.4686   -1.5346   -1.5592   -1.5346
   -0.1515   -0.2285   -0.3121   -0.4108   -0.5248   -0.6541   -0.7978   -0.9313   -1.0697   -1.2087   -1.3429   -1.4646   -1.5250   -1.5425   -1.5089
   -0.1663   -0.2429   -0.3259   -0.4240   -0.5373   -0.6655   -0.8079   -0.9397   -1.0759   -1.2122   -1.3429   -1.4601   -1.5148   -1.5251   -1.4822
   -0.1810   -0.2572   -0.3398   -0.4372   -0.5496   -0.6768   -0.8179   -0.9479   -1.0819   -1.2154   -1.3425   -1.4552   -1.5040   -1.5069   -1.4546
   -0.1957   -0.2715   -0.3535   -0.4503   -0.5619   -0.6880   -0.8277   -0.9560   -1.0877   -1.2183   -1.3417   -1.4497   -1.4926   -1.4879   -1.4259
   -0.2103   -0.2858   -0.3673   -0.4633   -0.5741   -0.6991   -0.8373   -0.9638   -1.0932   -1.2209   -1.3406   -1.4438   -1.4806   -1.4681   -1.3962
   -0.2250   -0.3000   -0.3809   -0.4763   -0.5861   -0.7100   -0.8468   -0.9715   -1.0985   -1.2232   -1.3390   -1.4373   -1.4679   -1.4475   -1.3655
   -0.2396   -0.3141   -0.3945   -0.4892   -0.5981   -0.7208   -0.8562   -0.9789   -1.1036   -1.2252   -1.3371   -1.4304   -1.4546   -1.4260   -1.3336
   -0.2541   -0.3283   -0.4081   -0.5020   -0.6100   -0.7315   -0.8654   -0.9862   -1.1084   -1.2268   -1.3347   -1.4229   -1.4406   -1.4037   -1.3007
   -0.2687   -0.3423   -0.4216   -0.5148   -0.6218   -0.7421   -0.8744   -0.9932   -1.1129   -1.2281   -1.3319   -1.4149   -1.4259   -1.3805   -1.2667
   -0.2832   -0.3564   -0.4350   -0.5274   -0.6335   -0.7526   -0.8833   -1.0001   -1.1172   -1.2291   -1.3287   -1.4063   -1.4105   -1.3564   -1.2315
   -0.2976   -0.3703   -0.4484   -0.5400   -0.6451   -0.7629   -0.8920   -1.0067   -1.1212   -1.2297   -1.3250   -1.3971   -1.3943   -1.3313   -1.1951
   -0.3120   -0.3843   -0.4617   -0.5525   -0.6566   -0.7731   -0.9005   -1.0131   -1.1249   -1.2300   -1.3209   -1.3874   -1.3774   -1.3053   -1.1575
   -0.3264   -0.3981   -0.4749   -0.5650   -0.6680   -0.7832   -0.9089   -1.0193   -1.1283   -1.2299   -1.3163   -1.3770   -1.3598   -1.2784   -1.1187
   -0.3407   -0.4120   -0.4881   -0.5773   -0.6793   -0.7931   -0.9170   -1.0253   -1.1314   -1.2294   -1.3112   -1.3661   -1.3414   -1.2504   -1.0786
   -0.3550   -0.4257   -0.5012   -0.5896   -0.6904   -0.8029   -0.9250   -1.0310   -1.1343   -1.2286   -1.3057   -1.3546   -1.3222   -1.2215   -1.0372
   -0.3693   -0.4394   -0.5142   -0.6017   -0.7015   -0.8125   -0.9329   -1.0365   -1.1368   -1.2273   -1.2996   -1.3424   -1.3022   -1.1915   -0.9946
   -0.3835   -0.4531   -0.5272   -0.6138   -0.7124   -0.8220   -0.9405   -1.0418   -1.1390   -1.2257   -1.2930   -1.3295   -1.2813   -1.1605   -0.9505
   -0.3976   -0.4667   -0.5401   -0.6258   -0.7232   -0.8313   -0.9479   -1.0468   -1.1409   -1.2237   -1.2860   -1.3160   -1.2596   -1.1283   -0.9051
   -0.4117   -0.4803   -0.5529   -0.6377   -0.7339   -0.8405   -0.9551   -1.0515   -1.1425   -1.2212   -1.2783   -1.3018   -1.2370   -1.0951   -0.8583
   -0.4258   -0.4937   -0.5656   -0.6494   -0.7445   -0.8495   -0.9621   -1.0560   -1.1438   -1.2183   -1.2702   -1.2869   -1.2136   -1.0607   -0.8100
   -0.4398   -0.5072   -0.5783   -0.6611   -0.7549   -0.8583   -0.9690   -1.0602   -1.1447   -1.2150   -1.2614   -1.2713   -1.1892   -1.0252   -0.7602
   -0.4538   -0.5205   -0.5909   -0.6727   -0.7652   -0.8670   -0.9756   -1.0642   -1.1452   -1.2112   -1.2522   -1.2550   -1.1639   -0.9885   -0.7089
   -0.4677   -0.5338   -0.6034   -0.6842   -0.7754   -0.8755   -0.9819   -1.0678   -1.1454   -1.2070   -1.2423   -1.2379   -1.1377   -0.9505   -0.6561
   -0.4816   -0.5471   -0.6158   -0.6956   -0.7855   -0.8838   -0.9881   -1.0712   -1.1452   -1.2023   -1.2318   -1.2201   -1.1105   -0.9114   -0.6017
   -0.4954   -0.5602   -0.6281   -0.7068   -0.7954   -0.8920   -0.9940   -1.0743   -1.1447   -1.1971   -1.2207   -1.2015   -1.0822   -0.8709   -0.5457
   -0.5092   -0.5733   -0.6404   -0.7180   -0.8051   -0.9000   -0.9997   -1.0771   -1.1437   -1.1914   -1.2090   -1.1821   -1.0530   -0.8292   -0.4880
   -0.5229   -0.5864   -0.6525   -0.7290   -0.8147   -0.9078   -1.0052   -1.0795   -1.1424   -1.1852   -1.1967   -1.1618   -1.0227   -0.7861   -0.4286
   -0.5366   -0.5993   -0.6646   -0.7399   -0.8242   -0.9153   -1.0104   -1.0817   -1.1407   -1.1786   -1.1836   -1.1408   -0.9914   -0.7417   -0.3675
   -0.5502   -0.6122   -0.6766   -0.7507   -0.8335   -0.9227   -1.0153   -1.0835   -1.1386   -1.1714   -1.1700   -1.1188   -0.9590   -0.6958   -0.3047
   -0.5637   -0.6250   -0.6885   -0.7614   -0.8426   -0.9299   -1.0200   -1.0850   -1.1360   -1.1636   -1.1556   -1.0961   -0.9254   -0.6486   -0.2400
   -0.5772   -0.6378   -0.7002   -0.7720   -0.8516   -0.9369   -1.0245   -1.0862   -1.1330   -1.1553   -1.1406   -1.0724   -0.8907   -0.5999   -0.1734
   -0.5906   -0.6504   -0.7119   -0.7824   -0.8604   -0.9437   -1.0286   -1.0871   -1.1296   -1.1465   -1.1248   -1.0478   -0.8549   -0.5497   -0.1050
   -0.6040   -0.6630   -0.7235   -0.7927   -0.8691   -0.9503   -1.0325   -1.0875   -1.1257   -1.1371   -1.1083   -1.0222   -0.8178   -0.4980   -0.0346
   -0.6173   -0.6755   -0.7350   -0.8028   -0.8776   -0.9566   -1.0361   -1.0877   -1.1214   -1.1270   -1.0910   -0.9957   -0.7796   -0.4447    0.0378
   -0.6305   -0.6879   -0.7463   -0.8129   -0.8859   -0.9627   -1.0395   -1.0874   -1.1166   -1.1164   -1.0730   -0.9683   -0.7401   -0.3899    0.1122
   -0.6437   -0.7002   -0.7576   -0.8228   -0.8940   -0.9686   -1.0425   -1.0868   -1.1113   -1.1052   -1.0542   -0.9398   -0.6993   -0.3334    0.1887
   -0.6568   -0.7125   -0.7687   -0.8325   -0.9020   -0.9743   -1.0452   -1.0858   -1.1056   -1.0934   -1.0346   -0.9103   -0.6572   -0.2752    0.2673
   -0.6698   -0.7246   -0.7797   -0.8421   -0.9097   -0.9797   -1.0476   -1.0844   -1.0993   -1.0809   -1.0142   -0.8798   -0.6137   -0.2154    0.3481
   -0.6827   -0.7367   -0.7906   -0.8515   -0.9173   -0.9849   -1.0497   -1.0826   -1.0925   -1.0677   -0.9929   -0.8481   -0.5689   -0.1537    0.4311
   -0.6956   -0.7486   -0.8014   -0.8608   -0.9247   -0.9898   -1.0515   -1.0804   -1.0852   -1.0539   -0.9708   -0.8154   -0.5227   -0.0904    0.5164
   -0.7084   -0.7605   -0.8121   -0.8699   -0.9318   -0.9944   -1.0530   -1.0777   -1.0773   -1.0394   -0.9478   -0.7816   -0.4751   -0.0251    0.6041
   -0.7212   -0.7723   -0.8226   -0.8789   -0.9388   -0.9988   -1.0541   -1.0747   -1.0689   -1.0242   -0.9239   -0.7466   -0.4260    0.0420    0.6941
   -0.7338   -0.7839   -0.8331   -0.8877   -0.9455   -1.0030   -1.0549   -1.0712   -1.0600   -1.0082   -0.8990   -0.7105   -0.3754    0.1110    0.7865
   -0.7464   -0.7955   -0.8433   -0.8964   -0.9521   -1.0068   -1.0553   -1.0672   -1.0504   -0.9915   -0.8733   -0.6731   -0.3233    0.1819    0.8814
   -0.7589   -0.8070   -0.8535   -0.9048   -0.9584   -1.0104   -1.0554   -1.0628   -1.0403   -0.9741   -0.8465   -0.6345   -0.2696    0.2549    0.9789
   -0.7713   -0.8183   -0.8635   -0.9131   -0.9645   -1.0137   -1.0551   -1.0579   -1.0295   -0.9559   -0.8188   -0.5947   -0.2143    0.3299    1.0790
   -0.7836   -0.8296   -0.8734   -0.9212   -0.9703   -1.0166   -1.0544   -1.0525   -1.0182   -0.9369   -0.7901   -0.5536   -0.1573    0.4069    1.1818
   -0.7958   -0.8407   -0.8831   -0.9291   -0.9760   -1.0193   -1.0533   -1.0467   -1.0062   -0.9172   -0.7604   -0.5111   -0.0987    0.4862    1.2873
   -0.8080   -0.8517   -0.8927   -0.9369   -0.9813   -1.0217   -1.0518   -1.0403   -0.9936   -0.8965   -0.7296   -0.4673   -0.0384    0.5676    1.3955
   -0.8200   -0.8626   -0.9021   -0.9444   -0.9865   -1.0238   -1.0500   -1.0334   -0.9803   -0.8751   -0.6977   -0.4222    0.0237    0.6513    1.5067
   -0.8320   -0.8734   -0.9114   -0.9518   -0.9914   -1.0255   -1.0477   -1.0260   -0.9663   -0.8528   -0.6647   -0.3756    0.0876    0.7372    1.6207
   -0.8439   -0.8841   -0.9205   -0.9589   -0.9960   -1.0269   -1.0450   -1.0180   -0.9517   -0.8295   -0.6306   -0.3276    0.1533    0.8255    1.7378
   -0.8556   -0.8946   -0.9294   -0.9659   -1.0003   -1.0280   -1.0418   -1.0095   -0.9363   -0.8054   -0.5954   -0.2781    0.2209    0.9162    1.8579
   -0.8673   -0.9050   -0.9382   -0.9726   -1.0044   -1.0287   -1.0382   -1.0004   -0.9202   -0.7804   -0.5589   -0.2271    0.2904    1.0093    1.9811
   -0.8789   -0.9153   -0.9468   -0.9791   -1.0083   -1.0290   -1.0342   -0.9908   -0.9034   -0.7544   -0.5213   -0.1746    0.3619    1.1050    2.1076
   -0.8903   -0.9254   -0.9553   -0.9854   -1.0118   -1.0290   -1.0297   -0.9805   -0.8858   -0.7275   -0.4824   -0.1205    0.4354    1.2032    2.2373
   -0.9017   -0.9354   -0.9636   -0.9914   -1.0150   -1.0287   -1.0247   -0.9697   -0.8674   -0.6996   -0.4422   -0.0648    0.5110    1.3041    2.3703
   -0.9129   -0.9453   -0.9717   -0.9973   -1.0180   -1.0279   -1.0193   -0.9582   -0.8483   -0.6706   -0.4008   -0.0074    0.5886    1.4076    2.5068
   -0.9240   -0.9550   -0.9796   -1.0029   -1.0206   -1.0268   -1.0133   -0.9461   -0.8283   -0.6406   -0.3580    0.0516    0.6685    1.5139    2.6468
   -0.9350   -0.9645   -0.9873   -1.0082   -1.0229   -1.0253   -1.0069   -0.9334   -0.8075   -0.6096   -0.3139    0.1124    0.7505    1.6230    2.7904
   -0.9459   -0.9740   -0.9948   -1.0133   -1.0250   -1.0233   -0.9999   -0.9199   -0.7859   -0.5775   -0.2684    0.1749    0.8348    1.7349    2.9376
   -0.9567   -0.9832   -1.0021   -1.0182   -1.0266   -1.0210   -0.9924   -0.9058   -0.7634   -0.5442   -0.2215    0.2393    0.9213    1.8498    3.0886
   -0.9674   -0.9923   -1.0093   -1.0228   -1.0280   -1.0182   -0.9843   -0.8910   -0.7400   -0.5099   -0.1732    0.3055    1.0103    1.9677    3.2434
   -0.9779   -1.0013   -1.0162   -1.0271   -1.0290   -1.0150   -0.9757   -0.8755   -0.7157   -0.4743   -0.1233    0.3736    1.1016    2.0887    3.4022
   -0.9883   -1.0101   -1.0229   -1.0312   -1.0297   -1.0114   -0.9665   -0.8593   -0.6905   -0.4376   -0.0720    0.4436    1.1954    2.2129    3.5649
   -0.9986   -1.0187   -1.0294   -1.0349   -1.0300   -1.0072   -0.9568   -0.8423   -0.6643   -0.3997   -0.0191    0.5156    1.2918    2.3402    3.7318
   -1.0087   -1.0271   -1.0356   -1.0384   -1.0300   -1.0027   -0.9464   -0.8246   -0.6371   -0.3606    0.0354    0.5896    1.3907    2.4709    3.9029
   -1.0187   -1.0354   -1.0417   -1.0416   -1.0296   -0.9976   -0.9355   -0.8061   -0.6090   -0.3201    0.0915    0.6657    1.4923    2.6049    4.0782
   -1.0285   -1.0434   -1.0475   -1.0446   -1.0288   -0.9921   -0.9239   -0.7868   -0.5798   -0.2784    0.1493    0.7439    1.5965    2.7424    4.2580
   -1.0382   -1.0513   -1.0531   -1.0472   -1.0276   -0.9861   -0.9117   -0.7667   -0.5496   -0.2353    0.2087    0.8243    1.7036    2.8834    4.4423
   -1.0478   -1.0590   -1.0584   -1.0495   -1.0260   -0.9795   -0.8988   -0.7457   -0.5184   -0.1909    0.2699    0.9069    1.8134    3.0280    4.6311
   -1.0572   -1.0665   -1.0635   -1.0514   -1.0240   -0.9725   -0.8853   -0.7239   -0.4860   -0.1451    0.3329    0.9917    1.9262    3.1763    4.8247
   -1.0665   -1.0739   -1.0683   -1.0531   -1.0216   -0.9649   -0.8710   -0.7013   -0.4526   -0.0979    0.3977    1.0789    2.0419    3.3283    5.0231
   -1.0756   -1.0810   -1.0729   -1.0544   -1.0188   -0.9567   -0.8561   -0.6777   -0.4180   -0.0492    0.4644    1.1685    2.1606    3.4843    5.2264];

%}

%%

function [reducedLUT, row_divisions, col_divisions] = hierarchical_lut_reduction(LUT, distance_metric)
  % Flatten LUT into data points
  data_points = LUT(:);

  % Perform hierarchical clustering
  Z = linkage(data_points, 'ward');  % Ward's method for minimizing variance

  % normal clustering:
  N_clusters = 3;
  T = cluster(Z,'maxclust',N_clusters);
  % visualization:
  LUT
  reshape(T, size(LUT))

  % Define threshold for significant variance increase
  threshold = prctile(Z(:,2), 20); %0.1 * max(Z(:,2));  % Adjust threshold based on your data

  % Identify boundaries based on threshold
  %boundaries = cut(Z, threshold);
  % Identify significant merges based on threshold
  significant_merges = Z(:,2) >= threshold;

  % Find indices of significant merges in the cluster hierarchy
  boundary_indices = find(significant_merges==0);

  % Extract cluster assignments based on significant merges
  cluster_assignments = cluster(Z, 'MaxClust', length(boundary_indices));
  reshape(cluster_assignments, size(LUT))

  % Extract cluster assignments
  %cluster_assignments = cluster(Z, 'MaxClust', numel(boundaries));

  % Determine LUT dimensions based on number of clusters
  num_clusters = numel(unique(cluster_assignments));
  rows = ceil(sqrt(num_clusters));  % Assuming square-ish grid
  cols = rows;

  % Initialize reduced LUT
  reducedLUT = zeros(rows, cols);

  % Loop through clusters and populate reduced LUT
  for i = 1:rows
    for j = 1:cols
      cluster_index = (i - 1)*cols + j;
      indices = find(cluster_assignments == cluster_index);
      reducedLUT(i, j) = mean(data_points(indices));  % Use mean for summary statistic
    end
  end

  % Identify row and column divisions based on cluster assignments
  [~, row_divisions] = unique(cluster_assignments(1:cols), 'first');
  col_divisions = unique(cluster_assignments(cols*(rows-1)+1:end));

  % Adjust divisions for zero-based indexing
  row_divisions = row_divisions - 1;
  col_divisions = col_divisions - 1;
end
